\chapter{Testing and Evaluation}\label{testing}

    \section{Performace Evaluation}
        - Sequential vs Parallel
            -	31 frames process vs 16 frames process
            -	Caffe MobileNet SSD vs Darknet YOLO model
                - YOLO
                    - use more memory because it calls lots of native libs (C++) which is very expensive.
                        - GC collect very often
                        - Programme is frozen
                    - More accuracy
                        - Able to detect person with confidence threshold 0.5
                - SSD
                    - Use less memory
                        - No GC collecting
                    - Less accuracy
                        - Able to detect person with confidence threshold 0.3


        % Picture Performance Table
        \begin{table}[!htp]\centering
            \scriptsize
            \begin{tabular}{lrrrrrr}\toprule
                \multicolumn{2}{c}{Model} &\multicolumn{2}{c}{YOLO} &\multicolumn{2}{c}{SSD} \\\midrule
                \multicolumn{2}{c}{Size} &960×540 &540x480 &960×540 &540x480 \\
                \multicolumn{2}{c}{Total Process Time (second)} &4.235 &3.827 &0.337 &0.323 \\
                \multicolumn{2}{c}{Forward Propagation per frame (second)} &3.456 &3.019 &0.284 &0.278 \\
                \multicolumn{2}{c}{Forward Propagation per frame (perenctage)} &81.61\% &78.89\% &84.27\% &86.07\% \\
                \bottomrule
            \end{tabular}

            \caption{Picture Processing Performace}\label{performance:picture}
        \end{table}

        % YOLO Model Performace Table
        \begin{table}[!htp]\centering
            \scriptsize
            \begin{tabular}{lrrrrrrr}\toprule
                \multicolumn{2}{c}{Model} &\multicolumn{5}{c}{YOLO} \\\cmidrule{1-7}
                \multicolumn{2}{c}{\multirow{2}{*}{}} &\multirow{2}{*}{Sequential Computing} &\multicolumn{4}{c}{Parallel Computing} \\\cmidrule{4-7}
                & & &1 Thread &2 Threads &4 Threads &8 Threads \\\midrule
                \multicolumn{2}{c}{Total Process Time (second)} &102.972 &117.805 &96.415 &92.242 &99.441 \\
                \multicolumn{2}{c}{Garbage Collector (second)} &- &0.102 &0.280 &2.024 &11.333 \\
                \multicolumn{2}{c}{Process Time without GC} &- &117.703 &96.136 &90.218 &88.108 \\
                \multicolumn{2}{c}{Forward Propagation (Total)} &79.097 &- &- &- &- \\
                \multicolumn{2}{c}{Forward Propagation (Average)} &2.553 &2.872 &4.840 &9.231 &19.713 \\
                \multicolumn{2}{c}{Forward Propagation (Min)} &2.213 &2.564 &4.003 &5.478 &14.733 \\
                \multicolumn{2}{c}{Forward Propagation (Max)} &2.693 &3.092 &6.436 &12.566 &21.815 \\
                \multicolumn{2}{c}{Number of frame} &31 &31 &31 &31 &31 \\
                \multicolumn{2}{c}{Process per frame (second)} &3.322 &3.800 &3.110 &2.976 &3.208 \\
                \multicolumn{2}{c}{Improvement} & & &18.16\% &21.70\% &15.59\% \\
                \bottomrule
            \end{tabular}

            \caption{Video Processing with YOLO Model with official build}\label{yolo:official-performace}
        \end{table}

        % SSD Model Performace Table
        \begin{table}[!htp]\centering
            \scriptsize
            \begin{tabular}{lrrrrrrr}\toprule
                \multicolumn{2}{c}{Model} &\multicolumn{5}{c}{SSD, OpenCV 3.4.0 Official Build} \\\cmidrule{1-7}
                \multicolumn{2}{c}{\multirow{2}{*}{}} &\multirow{2}{*}{Sequential Computing} &\multicolumn{4}{c}{Multithreading} \\\cmidrule{4-7}
                & & &1 Thread &2 Threads &4 Threads &8 Threads \\\midrule
                \multicolumn{2}{c}{Total Process Time (second)} &7.132 &8.237 &6.873 &6.270 &5.064 \\
                \multicolumn{2}{c}{Garbage Collector (second)} &- &- &- &- &- \\
                \multicolumn{2}{c}{Process Time without GC} &- &- &- &- &- \\
                \multicolumn{2}{c}{Forward Propagation (Total)} &7.019 &- &- &- &- \\
                \multicolumn{2}{c}{Forward Propagation (Average)} &0.226 &0.235 &0.401 &0.738 &1.133 \\
                \multicolumn{2}{c}{Forward Propagation (Min)} &0.218 &0.212 &0.353 &0.406 &0.466 \\
                \multicolumn{2}{c}{Forward Propagation (Max)} &0.243 &0.320 &0.456 &1.477 &2.582 \\
                \multicolumn{2}{c}{Number of frame} &31 &31 &31 &31 &31 \\
                \multicolumn{2}{c}{Process per frame (second)} &0.230 &0.266 &0.222 &0.202 &0.163 \\
                \multicolumn{2}{c}{Improvement} & & &16.56\% &23.88\% &38.52\% \\
                \bottomrule
            \end{tabular}

            \caption{Video Processing with MobileNet SSD Model with official}\label{ssd:official-performace}
        \end{table}

        \begin{table}[!htp]\centering
            \scriptsize
            \begin{tabular}{lrrrrrrr}\toprule
                \multicolumn{2}{c}{Model} &\multicolumn{5}{c}{MobileNet SSD without NEON} \\\cmidrule{1-7}
                \multicolumn{2}{c}{\multirow{2}{*}{}} &\multirow{2}{*}{Sequential Computing} &\multicolumn{4}{c}{Parallel Computing} \\\cmidrule{4-7}
                & & &1 Thread &2 Threads &4 Threads &8 Threads \\\midrule
                \multicolumn{2}{c}{Total Process Time (second)} &17.308 &19.030 &15.172 &11.797 &10.624 \\
                \multicolumn{2}{c}{Garbage Collector (second)} &- &- &- &- &- \\
                \multicolumn{2}{c}{Process Time without GC} &- &- &- &- &- \\
                \multicolumn{2}{c}{Forward Propagation (Total)} &17.193 &17.848 &- &- &- \\
                \multicolumn{2}{c}{Forward Propagation (Average)} &0.555 &0.576 &0.926 &1.416 &2.462 \\
                \multicolumn{2}{c}{Forward Propagation (Min)} &0.519 &0.545 &0.582 &0.756 &1.310 \\
                \multicolumn{2}{c}{Forward Propagation (Max)} &0.586 &0.654 &1.412 &2.593 &5.308 \\
                \multicolumn{2}{c}{Number of frame} &31 &31 &31 &31 &31 \\
                \multicolumn{2}{c}{Process per frame (second)} &0.558 &0.614 &0.489 &0.381 &0.343 \\
                \multicolumn{2}{c}{Improvement} & & &20.27\% &38.01\% &44.17\% \\
                \bottomrule
            \end{tabular}

            \caption{Video Processing with MobileNet SSD Model without NEON}\label{ssd:non-neon-performance}
        \end{table}

        \begin{table}[!htp]\centering
            \scriptsize
            \begin{tabular}{lrrrrrrr}\toprule
                \multicolumn{2}{c}{Model} &\multicolumn{5}{c}{MobileNet SSD with NEON} \\\cmidrule{1-7}
                \multicolumn{2}{c}{\multirow{2}{*}{}} &\multirow{2}{*}{Sequential Computing} &\multicolumn{4}{c}{Multithreading} \\\cmidrule{4-7}
                & & &1 Thread &2 Threads &4 Threads &8 Threads \\\midrule
                \multicolumn{2}{c}{Total Process Time (second)} &4.006 &6.079 &4.208 &3.127 &2.890 \\
                \multicolumn{2}{c}{Garbage Collector (second)} &- &- &- &- &- \\
                \multicolumn{2}{c}{Process Time without GC} &- &- &- &- &- \\
                \multicolumn{2}{c}{Forward Propagation (Total)} &3.927 &4.950 &- &- &- \\
                \multicolumn{2}{c}{Forward Propagation (Average)} &0.126 &0.159 &0.225 &0.339 &0.645 \\
                \multicolumn{2}{c}{Forward Propagation (Min)} &0.117 &0.128 &0.131 &0.190 &0.266 \\
                \multicolumn{2}{c}{Forward Propagation (Max)} &0.135 &0.250 &0.295 &0.596 &1.798 \\
                \multicolumn{2}{c}{Number of frame} &31 &31 &31 &31 &31 \\
                \multicolumn{2}{c}{Process per frame (second)} &0.129 &0.196 &0.136 &0.101 &0.093 \\
                \multicolumn{2}{c}{Improvement} & & &30.78\% &48.56\% &52.46\% \\
                \bottomrule
            \end{tabular}

            \caption{Video Processing with MobileNet SSD Model with NEON}\label{ssd:neon-performance}
        \end{table}

        -	Limitation / Problem
            - Limited Resource
                - CPU clock speed
                - RAM
                - Power resources

            - CPU
                - ARM architecture limitation on floating-point [http://tinyurl.com/y85ykaqa]
                - When the number of threads is increasing, image processing task is not consistently processed by core.
                    - Because the given task has to wait while core switching and doing another task (context switching)
                    - Thus, the given task requires more time to be finished
                - There are stages of CPU's clock frequency
            - JNI
                - Calling JNI is expensive [ref]

            -	Multithread Performance Analysis
                - I/O in thread
                    - If there is I/O operation in thread or loop, it will cost a lot of overhead
                - Out of memory
                    - If let each thread hold the large variable, it will cost memory overhead.
                    - We have to free the variables after used. Otherwise, the x+1 th thread will allocate another xx MB.
                - Young generation
                    - If there are lot of variables that are initialled in loop, there will be a lot young generation in the heap. So, when the number of young generations is reaching the threshold, GC will correct the young generation (freeing garbage in young generation heap) which affect the performance.
                - GC
                    - Caused by Native [https://developer.android.com/studio/profile/memory-profiler]
                    - Bin is GC
                    - 8 GB (available only 3.8 GB)
                - CPU hits 100% when performing tasks
                - CPU drops when GC is started
                        - Because threads are paused (Yellow) when GC is collecting

            - Thread Pool Problem
                - Thread Pool only improve when there are large number of asynchronous tasks. [https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ThreadPoolExecutor.html]

        % Memory Usgae
        \begin{figure}[!ht]
            \includegraphics[width=6in]{images/chapter5/gc-problem/gc-collecting.png}
            \caption{YOLO Model's Memory Usage}
            \label{yolo:memoryUsage}
        \end{figure}

        % CPU Usage
        \begin{figure}[!ht]
            \includegraphics[width=6in]{images/chapter5/YOLO/cpu-usage-8threads.png}
            \caption{YOLO Model's CPU Usage}
            \label{yolo:cpuUsage}
        \end{figure}

    \section{Usability Testing}